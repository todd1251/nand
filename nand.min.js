function AndView(a,b,c){var d=c.createPath();d.moveTo({x:0,y:0});d.lineTo({x:b.wideSegmentWidth,y:0});var f={x:b.gateWidth,y:b.halfHeight};d.arcTo({x:b.wideSegmentWidth+1,y:0},f);d=a.decorate(d,b,c);f.x=d.bounds.width;d.arcTo({x:b.wideSegmentWidth+1,y:b.height},{x:b.wideSegmentWidth,y:b.height});d.lineTo({x:0,y:b.height});d.closePath();d.alignmentCentre={x:b.gateWidth/2,y:b.halfHeight};a=b.height/4;d.inputs=[{x:0,y:a},{x:0,y:b.height-a}];d.outputs=[f];return d};function AppearanceProportionalToDimensions(a,b){b=b||{};this.stroke={width:b.strokeWidth||a.width/25,colour:b.strokeColour||"black"};this.wireStrokeWidth=.5*this.stroke.width;this.fill={colour:b.fillColour||"white"}}AppearanceProportionalToDimensions.prototype.createPath=function(){return new paper.Path({strokeWidth:this.stroke.width,strokeColor:this.stroke.colour,fillColor:this.fill.colour})};function BufferView(a,b,c){var d=c.createPath();d.moveTo({x:0,y:0});var f={x:b.wideSegmentWidth-c.stroke.width,y:b.halfHeight};d.lineTo(f);d=a.decorate(d,b,c);f.x=d.bounds.width;d.lineTo({x:0,y:b.height});d.closePath();d.alignmentCentre={x:b.wideSegmentWidth/2,y:b.halfHeight};d.inputs=[{x:0,y:b.halfHeight}];d.outputs=[f];return d};function CircuitView(a,b,c){a=a.map(function(a){return new a(b,c)});for(var d=0;d<a.length;d++){var f=a[d];console.log(f.bounds);if(0==d)f.position={x:0,y:0};else{var e=a[d-1];f.position={x:e.position.x+e.outputs[0].x-e.inputs[0].x,y:e.position.y+e.outputs[0].y-f.inputs[0].y}}}d=new paper.Group(a);f=a[0];a=a[a.length-1];d.inputs=[{x:f.position.x,y:f.position.y+f.inputs[0].y}];d.outputs=[{x:a.position.x+a.outputs[0].x-a.inputs[0].x,y:a.position.y+a.outputs[0].y}];return d};function DimensionsProportionalToWidth(a){this.width=a=a||100;this.wireWidth=a/5;this.gateWidth=a-2*this.wireWidth;this.height=4*this.gateWidth/5;this.halfHeight=this.height/2;this.wideSegmentWidth=3*this.gateWidth/5;this.narrowSegmentWidth=2*this.gateWidth/5;this.inverterRadius=this.gateWidth/12};function dragHandlerChain(a,b){function c(a){for(var c=0;c<b.length&&(b[c].dragFinished(a),!a.stopped);c++);}a.onMouseDown=function(a){for(var c=0;c<b.length&&(b[c].dragStarted(a),!a.stopped);c++);};a.onMouseDrag=function(a){for(var c=0;c<b.length&&(b[c].drag(a),!a.stopped);c++);};a.onMouseUp=c;a.onMouseOut=c};function dragToCopy(a,b,c,d){function f(a){g=null}var e,g,k;a.onMouseDown=function(f){e=a.position;g=f.point;k=b(c,d);k.position={x:e.x,y:e.y};dragHandlerChain(k,[new MetaDragToConnect(k,d),new DragToMove(k,d)])};a.onMouseDrag=function(a){var b=a.point;k.position={x:e.x+b.x-g.x,y:e.y+b.y-g.y};a.stopPropagation()};a.onMouseUp=f;a.onMouseOut=f};function DragToMove(a,b){this.element=a;this.appearance=b}DragToMove.prototype.dragStarted=function(a){this.originalPosition=this.element.position;this.dragPosition=a.point;a.event.metaKey?this.moving=!1:(this.moving=!0,a.stopPropagation())};DragToMove.prototype.drag=function(a){var b=a.point;this.moving&&(this.element.position={x:this.originalPosition.x+b.x-this.dragPosition.x,y:this.originalPosition.y+b.y-this.dragPosition.y},redrawWires(this.appearance),a.stopPropagation())};
DragToMove.prototype.dragFinished=function(a){this.dragPosition=null;redrawWires(this.appearance)};function dragToPan(){function a(a){b=null}var b;paper.view.onMouseDown=function(a){b=a.point};paper.view.onMouseDrag=function(a){a=a.point;paper.view.center=new paper.Point({x:paper.view.center.x-(a.x-b.x),y:paper.view.center.y-(a.y-b.y)})};paper.view.onMouseUp=a;paper.view.onMouseOut=a};function GateView(a,b,c){a=new a(b,c);var d=b.width/2-a.alignmentCentre.x+a.inputs[0].x/2,f=[];f.push(a);b=[{x:b.width-d+a.inputs[0].x,y:a.outputs[0].y}];for(var e=new paper.Path.Line({from:a.outputs[0],to:b[0],strokeWidth:c.wireStrokeWidth,strokeColor:c.stroke.colour}),g=[],k=0;k<a.inputs.length;k++){var h=a.inputs[k];g[k]={x:h.x-d,y:h.y};f.push(new paper.Path.Line({from:g[k],to:{x:h.x,y:h.y},strokeWidth:c.wireStrokeWidth,strokeColor:c.stroke.colour}))}f.push(e);a=new paper.Group(f);a.inputs=g;a.outputs=
b;return a};function clamp(a,b,c){return Math.min(Math.max(a,b),c)};var wires=[];
function redrawWires(a){wires.map(function(b){var c=b.from,d=b.to,e=b.input;null!=b.path&&(null!=b.path.markers&&b.path.markers.map(function(a){a.remove()}),b.path.remove(),b.path=null);var f=a.createPath();f.strokeWidth=a.wireStrokeWidth;f.fillColor=null;c={x:c.position.x-c.bounds.width/2+c.outputs[0].x-c.inputs[0].x,y:c.position.y-c.bounds.height/2+c.outputs[0].y};d={x:d.position.x-d.bounds.width/2,y:d.position.y-d.bounds.height/2+d.inputs[e].y};e=d.x-c.x;f.moveTo({x:c.x,y:c.y});f.lineTo({x:c.x+e/
2,y:c.y});f.lineTo({x:c.x+e/2,y:d.y});f.lineTo({x:d.x,y:d.y});f.markers=[];b.path=f;b.pointFrom=c;b.pointTo=d});for(var b=[],c=0;c<wires.length;c++)for(var d=wires[c].path,f=c+1;f<wires.length;f++){var e=wires[f];if(null!=e.path){for(var g=[],k=e.path.getIntersections(d),h=0;h<k.length;h++)g.push(k[h].point);k=b.length;for(h=0;h<b.length;h++)if(b[h].wire==e){for(var k=h,n=0;n<b[h].points;n++)g.push(b[h].points[n]);break}g.sort(function(a,b){return a.x-b.x});b[k]={wire:e,intersections:g}}}for(f=0;f<
b.length;f++)if(c=b[f],k=c.intersections,d=c.wire.path,e=c.wire.pointFrom,g=c.wire.pointTo,0<k.length){n=d.markers;d.remove();d=a.createPath();d.strokeWidth=a.wireStrokeWidth;d.fillColor=null;var m=g.x-e.x;d.moveTo({x:e.x,y:e.y});for(h=0;h<k.length;h++){var l=k[h];console.log("#"+h+" at ("+l.x+", "+l.y+")")}h=0;l=k[h];l.x>=e.x&&l.x<=e.x+m/2&&l.y==e.y&&(console.log("intersection #"+f+" on first leg"),d.lineTo({x:l.x-5,y:e.y}),d.arcTo({x:l.x,y:e.y-5},{x:l.x+5,y:e.y}),h++);d.lineTo({x:e.x+m/2,y:e.y});
h<k.length&&(l=k[h],l.x==e.x+m/2&&l.y>=e.y&&l.y<=g.y&&(console.log("intersection #"+f+" on second leg"),d.lineTo({x:e.x+m/2,y:l.y-5}),d.arcTo({x:e.x+m/2+5,y:l.y},{x:e.x+m/2,y:l.y+5}),h++));h<k.length&&(l=k[h],l.x==e.x+m/2&&l.y>=g.y&&l.y<=e.y&&(console.log("intersection #"+f+" on second leg (reverse)"),d.lineTo({x:e.x+m/2,y:l.y+5}),d.arcTo({x:e.x+m/2+5,y:l.y},{x:e.x+m/2,y:l.y-5}),h++));d.lineTo({x:e.x+m/2,y:g.y});h<k.length&&(l=k[h],l.x>=e.x+m/2&&l.x<=g.x&&l.y==g.y&&(console.log("intersection #"+f+
" on third leg"),d.lineTo({x:l.x-5,y:g.y}),d.arcTo({x:l.x,y:g.y-5},{x:l.x+5,y:g.y})));d.lineTo({x:g.x,y:g.y});d.markers=n;c.wire.path=d}}function MetaDragToConnect(a,b){this.element=a;this.appearance=b}MetaDragToConnect.prototype.dragStarted=function(a){this.originalPosition=this.element.position;this.dragPosition=a.point;a.event.metaKey?(this.connecting=!0,a.stopPropagation()):this.connecting=!1};
MetaDragToConnect.prototype.drag=function(a){if(this.connecting){null!=this.path&&this.path.remove();this.path=this.appearance.createPath();this.path.strokeWidth=this.appearance.wireStrokeWidth;this.path.fillColor=null;var b=this.element.position.x-this.element.bounds.width/2+this.element.outputs[0].x-this.element.inputs[0].x,c=this.element.position.y-this.element.bounds.height/2+this.element.outputs[0].y,d=a.point.x,f=a.point.y,e=d-b;this.path.moveTo({x:b,y:c});this.path.lineTo({x:b+e/2,y:c});this.path.lineTo({x:b+
e/2,y:f});this.path.lineTo({x:d,y:f});a.stopPropagation()}};
MetaDragToConnect.prototype.dragFinished=function(a){this.dragPosition=null;null!=this.path&&this.path.remove();if(this.connecting){var b=paper.project.hitTestAll(a.point);console.log(b.length);if(0<b.length){for(var c=null,d=0;d<b.length;d++)if(null!=b[d].item.inputs){c=b[d];break}if(null==c){console.log("no hit");return}console.log(c.item.inputs);b=c.item.input;null==b?b=0:b++;if(b>=c.item.inputs.length)return;c.item.input=b;wires.push({from:this.element,to:c.item,input:b})}redrawWires(this.appearance);
a.stopPropagation()}};function render(){function a(a){return GateView.bind(null,a)}function b(){}function c(){}function d(a,b){var c=b(k,h);c.position=a;dragHandlerChain(c,[new MetaDragToConnect(c,h),new DragToMove(c,h)]);return c}paper.project.activeLayer.removeChildren();b.prototype.decorate=function(a,b,c){b=2*b.inverterRadius;a.arcBy({x:b,y:0},!1);a.arcBy({x:-b,y:0},!0);a.arcBy({x:b,y:0},!0);a.arcBy({x:-b,y:0},!1);return a};c.prototype.decorate=function(a,b,c){return a};var f=a(BufferView.bind(null,new c));a(BufferView.bind(null,
new b));a(AndView.bind(null,new c));var e=a(AndView.bind(null,new b));a(OrView.bind(null,new XorDecoration,new c));new paper.Path.Rectangle({point:[0,0],size:[paper.view.bounds.width,paper.view.bounds.height],strokeColor:"#ccc"});var g=50;[a(BufferView.bind(null,new c)),a(BufferView.bind(null,new b)),a(AndView.bind(null,new c)),a(AndView.bind(null,new b)),a(OrView.bind(null,new c,new c)),a(OrView.bind(null,new c,new b)),a(OrView.bind(null,new XorDecoration,new c)),a(OrView.bind(null,new XorDecoration,
new b))].map(function(a){var b=new DimensionsProportionalToWidth(50),c=new AppearanceProportionalToDimensions(b),d=new AppearanceProportionalToDimensions(b);d.stroke.colour="#ccc";d=new a(b,d);d.position={x:g,y:50};g+=1.1*d.bounds.width;dragToCopy(d,a,b,c)});var k=new DimensionsProportionalToWidth(50),h=new AppearanceProportionalToDimensions(k),n=d({x:150,y:150},f),f=d({x:150,y:250},f),m=d({x:250,y:200},e),l=d({x:350,y:150},e),p=d({x:350,y:250},e),e=d({x:450,y:200},e);wires.push({from:n,to:l,input:0});
wires.push({from:n,to:m,input:0});wires.push({from:f,to:m,input:1});wires.push({from:f,to:p,input:1});wires.push({from:m,to:l,input:1});wires.push({from:m,to:p,input:0});wires.push({from:l,to:e,input:0});wires.push({from:p,to:e,input:1});redrawWires(h)}window.addEventListener("load",function(){var a=document.getElementById("paper");paper.setup(a);paper.view.onFrame=function(a){paper.view.draw()};paper.view.onResize=function(a){render()};render();dragToPan();stableScrollToZoom(a)});function OrView(a,b,c,d){var f=c.gateWidth/7,e=d.createPath();e.moveTo({x:d.stroke.width/2,y:0});e.lineTo({x:c.narrowSegmentWidth,y:0});var g={x:c.gateWidth,y:c.halfHeight};e.arcTo({x:c.narrowSegmentWidth+c.wideSegmentWidth/2,y:c.halfHeight/4},g);e=b.decorate(e,c,d);g.x=e.bounds.width;e.arcTo({x:c.narrowSegmentWidth+c.wideSegmentWidth/2,y:c.height-c.halfHeight/4},{x:c.narrowSegmentWidth,y:c.height});e.lineTo({x:d.stroke.width/2,y:c.height});e.arcTo({x:f,y:c.halfHeight},{x:d.stroke.width/2,y:0});e.closePath();
e=a.decorate(e,c,d);e.alignmentCentre={x:c.gateWidth/2-f/2,y:c.halfHeight};a=c.height/4;e.inputs=[{x:f,y:a},{x:f,y:c.height-a}];e.outputs=[g];return e};function stableScrollToZoom(a){var b=0;a.addEventListener("mousewheel",function(a){var d=b+a.wheelDelta,f=clamp(Math.pow(1.001,d),.25,100),e=paper.view.zoom;if(f!=e){var g=e/f,k=paper.view.viewToProject({x:a.offsetX,y:a.offsetY}),e=paper.view.center,h=k.subtract(e),g=k.subtract(h.multiply(g)).subtract(e);paper.view.center=e.add(g);b=d;paper.view.zoom=f}a.preventDefault();return!1})};function XorDecoration(){}XorDecoration.prototype.decorate=function(a,b,c){var d=b.gateWidth/7,f=c.createPath(),e=2*c.stroke.width,g=1.2*(c.stroke.width/2-e),d=d-e;c=c.stroke.width/10;f.moveTo({x:g+c,y:0});f.lineTo({x:g,y:0});f.arcTo({x:d,y:b.halfHeight},{x:g,y:b.height});f.lineTo({x:g+c,y:b.height});f.arcTo({x:d,y:b.halfHeight},{x:g,y:0});f.lineTo({x:g+c,y:0});f.arcTo({x:d,y:b.halfHeight},{x:g,y:b.height});return new paper.Group([a,f])};
