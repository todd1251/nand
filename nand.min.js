function AndView(a,c,b,e){a=e.createPath();a.moveTo({x:0,y:0});a.lineTo({x:b.wideSegmentWidth,y:0});var f={x:b.gateWidth,y:b.halfHeight};a.arcTo({x:b.wideSegmentWidth+1,y:0},f);a=c.decorate(a,b,e);f.x=a.bounds.width;a.arcTo({x:b.wideSegmentWidth+1,y:b.height},{x:b.wideSegmentWidth,y:b.height});a.lineTo({x:0,y:b.height});a.closePath();a.alignmentCentre={x:b.gateWidth/2,y:b.halfHeight};c=b.height/4;a.inputs=[{x:0,y:c},{x:0,y:b.height-c}];a.outputs=[f];return a};function AppearanceProportionalToDimensions(a,c){c=c||{};this.stroke={width:c.strokeWidth||a.width/25,colour:c.strokeColour||"black"};this.wireStrokeWidth=.5*this.stroke.width;this.fill={colour:c.fillColour||"white"}}AppearanceProportionalToDimensions.prototype.createPath=function(){return new paper.Path({strokeWidth:this.stroke.width,strokeColor:this.stroke.colour,fillColor:this.fill.colour})};function BufferView(a,c,b,e){a=e.createPath();a.moveTo({x:0,y:0});var f={x:b.wideSegmentWidth-e.stroke.width,y:b.halfHeight-e.stroke.width/2};a.lineTo(f);a=c.decorate(a,b,e);f.x=a.bounds.width;a.lineTo({x:0,y:b.height-e.stroke.width});a.closePath();a.alignmentCentre={x:b.wideSegmentWidth/2,y:f.y};a.inputs=[{x:0,y:f.y}];a.outputs=[f];return a};function CircuitView(a,c,b){var e=[],f=[];a.map(function(a){a.onMouseDown=null;a.onMouseDrag=null;a.onMouseUp=null;a.onMouseOut=null;null==a.input&&e.push(a);null==a.output&&f.push(a)});var d=new paper.Group(a);d.alignmentCentre={x:d.bounds.width/2,y:d.bounds.height/2};dragHandlerChain(d,[new MetaDragToConnect(d,c,b),new DragToMove(d,b)]);var g=null,h=null;e.map(function(a){if(null==g||a.inputs[0].x<g)g=a.inputs[0].x;if(null==h||a.inputs[0].y<h)h=a.inputs[0].y});d.inputs=[];e.map(function(a){d.inputs.push({x:a.position.x-
a.alignmentCentre.x+a.inputs[0].x-d.position.x+d.alignmentCentre.x-g,y:a.position.y-a.alignmentCentre.y+a.inputs[0].y-d.position.y+d.alignmentCentre.y})});d.outputs=[];f.map(function(a){d.outputs.push({x:a.position.x-a.alignmentCentre.x+a.outputs[0].x-d.position.x+d.alignmentCentre.x,y:a.position.y-a.alignmentCentre.y+a.outputs[0].y-d.position.y+d.alignmentCentre.y})});return d};function DimensionsProportionalToWidth(a){this.width=a=a||100;this.wireWidth=a/5;this.gateWidth=a-2*this.wireWidth;this.height=4*this.gateWidth/5;this.halfHeight=this.height/2;this.wideSegmentWidth=3*this.gateWidth/5;this.narrowSegmentWidth=2*this.gateWidth/5;this.inverterRadius=this.gateWidth/12};function dragHandlerChain(a,c){function b(a){for(var b=0;b<c.length&&(c[b].dragFinished(a),!a.stopped);b++);}a.onMouseDown=function(a){for(var b=0;b<c.length&&(c[b].dragStarted(a),!a.stopped);b++);};a.onMouseDrag=function(a){for(var b=0;b<c.length&&(c[b].drag(a),!a.stopped);b++);};a.onMouseUp=b;a.onMouseOut=b};function dragToCopy(a,c,b,e){function f(a){g=null}var d,g,h;a.onMouseDown=function(f){d=a.position;g=f.point;h=c(b,e);h.position={x:d.x,y:d.y};dragHandlerChain(h,[new MetaDragToConnect(h,b,e),new DragToMove(h,e)])};a.onMouseDrag=function(a){var b=a.point;h.position={x:d.x+b.x-g.x,y:d.y+b.y-g.y};a.stopPropagation()};a.onMouseUp=f;a.onMouseOut=f};function DragToMove(a,c){this.element=a;this.appearance=c}DragToMove.prototype.dragStarted=function(a){this.originalPosition=this.element.position;this.dragPosition=a.point;a.event.metaKey?this.moving=!1:(this.moving=!0,a.stopPropagation())};DragToMove.prototype.drag=function(a){var c=a.point;this.moving&&(this.element.position={x:this.originalPosition.x+c.x-this.dragPosition.x,y:this.originalPosition.y+c.y-this.dragPosition.y},redrawWires(this.appearance),a.stopPropagation())};
DragToMove.prototype.dragFinished=function(a){this.dragPosition=null;redrawWires(this.appearance)};function DragToPan(a){this.element=a}DragToPan.prototype.dragStarted=function(a){this.dragPosition=a.point};DragToPan.prototype.drag=function(a){a=a.point;this.element.center=new paper.Point({x:this.element.center.x-(a.x-this.dragPosition.x),y:this.element.center.y-(a.y-this.dragPosition.y)})};DragToPan.prototype.dragFinished=function(a){this.dragPosition=null};function FanOutView(a,c,b){a=new a(c,b);var e=new paper.Path.Circle({radius:2,center:[a.outputs[0].x,a.outputs[0].y],strokeWidth:b.wireStrokeWidth,strokeColor:b.stroke.colour,fillColor:b.stroke.colour}),f=[];f.push(a);f.push(e);f.push(new paper.Path.Line({from:a.outputs[0],to:{x:a.outputs[0].x,y:a.outputs[0].y-c.wireWidth-b.wireStrokeWidth/2},strokeWidth:b.wireStrokeWidth,strokeColor:b.stroke.colour}));f.push(new paper.Path.Line({from:a.outputs[0],to:{x:a.outputs[0].x,y:a.outputs[0].y+c.wireWidth+
b.wireStrokeWidth/2},strokeWidth:b.wireStrokeWidth,strokeColor:b.stroke.colour}));b=new paper.Group(f);b.alignmentCentre={x:a.bounds.width/2,y:a.bounds.height/2};b.inputs=a.inputs;b.input=a.input;b.outputs=[{x:a.outputs[0].x,y:a.outputs[0].y-c.wireWidth},{x:a.outputs[0].x,y:a.outputs[0].y+c.wireWidth}];b.output=a.output;return b};function GateView(a,c,b){a=new a(c,b);var e=c.width/2-a.alignmentCentre.x+a.inputs[0].x/2,f=[];f.push(a);c=[{x:c.width-e+a.inputs[0].x+b.stroke.width/2,y:a.outputs[0].y}];for(var d=new paper.Path.Line({from:a.outputs[0],to:c[0],strokeWidth:b.wireStrokeWidth,strokeColor:b.stroke.colour}),g=[],h=0;h<a.inputs.length;h++){var k=a.inputs[h];g[h]={x:k.x-e-b.stroke.width/2,y:k.y};f.push(new paper.Path.Line({from:g[h],to:{x:k.x,y:k.y},strokeWidth:b.wireStrokeWidth,strokeColor:b.stroke.colour}))}f.push(d);
b=new paper.Group(f);b.alignmentCentre={x:a.bounds.width/2,y:a.bounds.height/2};b.inputs=g;b.outputs=c;return b};function InverterDecoration(){}InverterDecoration.prototype.decorate=function(a,c,b){c=2*c.inverterRadius;a.arcBy({x:c,y:0},!1);a.arcBy({x:-c,y:0},!0);a.arcBy({x:c,y:0},!0);a.arcBy({x:-c,y:0},!1);return a};function clamp(a,c,b){return Math.min(Math.max(a,c),b)};var wires=[];
function redrawWires(a){wires.map(function(b){var c=b.from,d=b.to,e=b.output,f=b.input;null!=b.path&&(null!=b.path.markers&&b.path.markers.map(function(a){a.remove()}),b.path.remove(),b.path=null);var g=a.createPath();g.strokeWidth=a.wireStrokeWidth;g.fillColor=null;c={x:c.position.x-c.alignmentCentre.x+c.outputs[e].x-c.inputs[0].x-a.stroke.width/2,y:c.position.y-c.alignmentCentre.y+c.outputs[e].y};d={x:d.position.x-d.alignmentCentre.x+d.inputs[f].x+a.stroke.width,y:d.position.y-d.alignmentCentre.y+d.inputs[f].y};
e=d.x-c.x;g.moveTo({x:c.x,y:c.y});g.lineTo({x:c.x+e/2,y:c.y});g.lineTo({x:c.x+e/2,y:d.y});g.lineTo({x:d.x,y:d.y});g.lineTo({x:d.x+1,y:d.y});g.markers=[];b.path=g;b.pointFrom=c;b.pointTo=d});for(var c=[],b=0;b<wires.length;b++)for(var e=wires[b].path,f=b+1;f<wires.length;f++){var d=wires[f];if(null!=d.path){for(var g=[],h=d.path.getIntersections(e),k=0;k<h.length;k++)g.push(h[k].point);h=c.length;for(k=0;k<c.length;k++)if(c[k].wire==d){for(var h=k,n=0;n<c[k].points;n++)g.push(c[k].points[n]);break}g.sort(function(a,
b){return a.x-b.x});c[h]={wire:d,intersections:g}}}for(f=0;f<c.length;f++)if(b=c[f],h=b.intersections,e=b.wire.path,d=b.wire.pointFrom,g=b.wire.pointTo,0<h.length){n=e.markers;e.remove();e=a.createPath();e.strokeWidth=a.wireStrokeWidth;e.fillColor=null;var m=g.x-d.x;e.moveTo({x:d.x,y:d.y});for(k=0;k<h.length;k++)var l=h[k];k=0;l=h[k];l.x>=d.x&&l.x<=d.x+m/2&&l.y==d.y&&(e.lineTo({x:l.x-5,y:d.y}),e.arcTo({x:l.x,y:d.y-5},{x:l.x+5,y:d.y}),k++);e.lineTo({x:d.x+m/2,y:d.y});k<h.length&&(l=h[k],l.x==d.x+m/
2&&l.y>=d.y&&l.y<=g.y&&(e.lineTo({x:d.x+m/2,y:l.y-5}),e.arcTo({x:d.x+m/2+5,y:l.y},{x:d.x+m/2,y:l.y+5}),k++));k<h.length&&(l=h[k],l.x==d.x+m/2&&l.y>=g.y&&l.y<=d.y&&(e.lineTo({x:d.x+m/2,y:l.y+5}),e.arcTo({x:d.x+m/2+5,y:l.y},{x:d.x+m/2,y:l.y-5}),k++));e.lineTo({x:d.x+m/2,y:g.y});k<h.length&&(l=h[k],l.x>=d.x+m/2&&l.x<=g.x&&l.y==g.y&&(e.lineTo({x:l.x-5,y:g.y}),e.arcTo({x:l.x,y:g.y-5},{x:l.x+5,y:g.y})));e.lineTo({x:g.x,y:g.y});e.markers=n;b.wire.path=e}}
function MetaDragToConnect(a,c,b){this.element=a;this.dimensions=c;this.appearance=b}MetaDragToConnect.prototype.dragStarted=function(a){this.originalPosition=this.element.position;this.dragPosition=a.point;a.event.metaKey?(this.connecting=!0,a.stopPropagation()):this.connecting=!1};
MetaDragToConnect.prototype.drag=function(a){if(this.connecting){null!=this.path&&this.path.remove();this.path=this.appearance.createPath();this.path.strokeWidth=this.appearance.wireStrokeWidth;this.path.fillColor=null;var c=this.element.output;null==c?c=0:(c++,c>=this.element.outputs.length&&c--);var b=this.element.position.x-this.element.bounds.width/2+this.element.outputs[c].x-this.element.inputs[0].x,c=this.element.position.y-this.element.bounds.height/2+this.element.outputs[c].y,e=a.point.x,
f=a.point.y,d=e-b;this.path.moveTo({x:b,y:c});this.path.lineTo({x:b+d/2,y:c});this.path.lineTo({x:b+d/2,y:f});this.path.lineTo({x:e,y:f});a.stopPropagation()}};
MetaDragToConnect.prototype.dragFinished=function(a){this.dragPosition=null;null!=this.path&&this.path.remove();if(this.connecting){var c=paper.project.hitTestAll(a.point);if(0<c.length){for(var b=null,e=0;e<c.length;e++)if(null!=c[e].item.inputs){b=c[e];break}if(null==b){console.log("no hit");return}for(b=b.item;null!=b.parent&&null==b.onMouseDrag;)b=b.parent;connect(this.element,b,this.dimensions,this.appearance)}a.stopPropagation()}};
function connect(a,c,b,e){var f=c.input;null==f?f=0:f++;if(!(f>=c.inputs.length)){c.input=f;var d=a.output;null==d?d=0:d++;if(!(2<=d)){a.output=d;if(1==d&&1==a.outputs.length){var g=a.position;a.position={x:a.bounds.width/2+a.inputs[0].x,y:a.bounds.height/2};var h=new FanOutView(function(b,c){return a},b,e);h.position=g;for(g=0;g<wires.length;g++){var k=wires[g];k.from==a&&(k.from=h)}a.onMouseDown=null;a.onMouseDrag=null;a.onMouseUp=null;a.onMouseOut=null;a=h;dragHandlerChain(a,[new MetaDragToConnect(a,
b,e),new DragToMove(a,e)])}wires.push({from:a,to:c,input:f,output:d});redrawWires(e);return a}}};function render(a,c){function b(a,b,c){b=b||new NoDecoration;c=c||new NoDecoration;return GateView.bind(null,a.bind(null,b,c))}function e(b,d){var e=d(a,c);e.position=b;dragHandlerChain(e,[new MetaDragToConnect(e,a,c),new DragToMove(e,c)]);return e}paper.project.activeLayer.removeChildren();wires=[];new paper.Path.Rectangle({point:[0,0],size:[paper.view.bounds.width,paper.view.bounds.height],strokeColor:"#ccc"});var f=b(BufferView),d=b(BufferView,void 0,new InverterDecoration),g=b(AndView),h=b(AndView,
void 0,new InverterDecoration),k=b(OrView),n=b(OrView,void 0,new InverterDecoration),m=b(XorView),l=b(XorView,void 0,new InverterDecoration),p=50;[f,d,g,h,k,n,m,l].map(function(b){var d=new AppearanceProportionalToDimensions(a);d.stroke.colour="#ccc";d=new b(a,d);d.position={x:p,y:50};d.isTool=!0;p+=1.1*d.bounds.width;dragToCopy(d,b,a,c)});h=e({x:120,y:150},f);k=e({x:150,y:200},f);n=e({x:250,y:146},m);l=e({x:250,y:204},g);h=connect(h,n,a,c);h=connect(h,l,a,c);k=connect(k,n,a,c);k=connect(k,l,a,c);
d=e({x:420,y:150},f);f=e({x:450,y:200},f);m=e({x:550,y:146},m);g=e({x:550,y:204},g);d=connect(d,m,a,c);d=connect(d,g,a,c);f=connect(f,m,a,c);f=connect(f,g,a,c);h=new CircuitView([h,k,n,l],a,c);g=new CircuitView([d,f,m,g],a,c);connect(h,g,a,c);connect(h,g,a,c)}
window.addEventListener("load",function(){var a=document.getElementById("paper");paper.setup(a);paper.view.onFrame=paper.view.draw();var c=new DimensionsProportionalToWidth(50),b=new AppearanceProportionalToDimensions(c);paper.view.onResize=render(c,b);render(c,b);dragHandlerChain(paper.view,[new ShiftDragToSelect(paper.view,c,b),new DragToPan(paper.view)]);stableScrollToZoom(a)});function NoDecoration(){}NoDecoration.prototype.decorate=function(a,c,b){return a};function OrView(a,c,b,e){var f=b.gateWidth/7,d=e.createPath();d.moveTo({x:e.stroke.width/2,y:0});d.lineTo({x:b.narrowSegmentWidth,y:0});var g={x:b.gateWidth,y:b.halfHeight};d.arcTo({x:b.narrowSegmentWidth+b.wideSegmentWidth/2,y:b.halfHeight/4},g);d=c.decorate(d,b,e);g.x=d.bounds.width;d.arcTo({x:b.narrowSegmentWidth+b.wideSegmentWidth/2,y:b.height-b.halfHeight/4},{x:b.narrowSegmentWidth,y:b.height});d.lineTo({x:e.stroke.width/2,y:b.height});d.arcTo({x:f,y:b.halfHeight},{x:e.stroke.width/2,y:0});d.closePath();
d=a.decorate(d,b,e);d.alignmentCentre={x:b.gateWidth/2-f/2,y:b.halfHeight};a=b.height/4;d.inputs=[{x:f,y:a},{x:f,y:b.height-a}];d.outputs=[g];return d};function ShiftDragToSelect(a,c,b){this.element=a;this.dimensions=c;this.appearance=b}ShiftDragToSelect.prototype.dragStarted=function(a){this.dragPosition=a.point;a.event.shiftKey?(this.selecting=!0,a.stopPropagation()):this.selecting=!1};
ShiftDragToSelect.prototype.drag=function(a){var c=a.point;if(this.selecting){null!=this.selection&&this.selection.remove();this.selection=new paper.Path.Rectangle({from:{x:this.dragPosition.x,y:this.dragPosition.y},to:{x:c.x,y:c.y},strokeColor:"#999",strokeWidth:1,dashArray:[3,1]});var b=this;this.selectedItems=paper.project.getItems({match:function(a){return a!=b.selection&&b.selection.contains(a.position)?(null==a.parent||null!=a.onMouseDrag)&&!(a.isTool||1==a.id):!1}});this.selectedItems.map(function(a){a.strokeColor=
"#ccc"});a.stopPropagation()}};ShiftDragToSelect.prototype.dragFinished=function(a){this.dragPosition=null;if(this.selecting){this.selecting=!1;this.selection.remove();this.selection=null;var c=this;this.selectedItems.map(function(a){a.strokeColor=c.appearance.stroke.colour});1<this.selectedItems.length&&new CircuitView(this.selectedItems,this.dimensions,this.appearance);this.selectedItems=[]}};function stableScrollToZoom(a){var c=0;a.addEventListener("mousewheel",function(a){var e=clamp(c+a.wheelDelta,-2500,5E3),f=Math.pow(1.001,e),d=paper.view.zoom;if(f!=d){var g=d/f,h=paper.view.viewToProject({x:a.offsetX,y:a.offsetY}),d=paper.view.center,k=h.subtract(d),g=h.subtract(k.multiply(g)).subtract(d);paper.view.center=d.add(g);c=e;paper.view.zoom=f}a.preventDefault();return!1})};function XorDecoration(){}XorDecoration.prototype.decorate=function(a,c,b){var e=c.gateWidth/7,f=b.createPath(),d=2*b.stroke.width,g=1.2*(b.stroke.width/2-d),e=e-d;b=b.stroke.width/10;f.moveTo({x:g+b,y:0});f.lineTo({x:g,y:0});f.arcTo({x:e,y:c.halfHeight},{x:g,y:c.height});f.lineTo({x:g+b,y:c.height});f.arcTo({x:e,y:c.halfHeight},{x:g,y:0});f.lineTo({x:g+b,y:0});f.arcTo({x:e,y:c.halfHeight},{x:g,y:c.height});return new paper.Group([a,f])};function XorView(a,c,b,e){return new OrView(new XorDecoration,c,b,e)};
