function AndView(a,c,b){var d=b.createPath();d.moveTo({x:0,y:0});d.lineTo({x:c.wideSegmentWidth,y:0});var f={x:c.gateWidth,y:c.halfHeight};d.arcTo({x:c.wideSegmentWidth+1,y:0},f);d=a.decorate(d,c,b);f.x=d.bounds.width;d.arcTo({x:c.wideSegmentWidth+1,y:c.height},{x:c.wideSegmentWidth,y:c.height});d.lineTo({x:0,y:c.height});d.closePath();d.alignmentCentre={x:c.gateWidth/2,y:c.halfHeight};a=c.height/4;d.inputs=[{x:0,y:a},{x:0,y:c.height-a}];d.outputs=[f];return d};function AppearanceProportionalToDimensions(a,c){c=c||{};this.stroke={width:c.strokeWidth||a.width/25,colour:c.strokeColour||"black"};this.wireStrokeWidth=.5*this.stroke.width;this.fill={colour:c.fillColour||"white"}}AppearanceProportionalToDimensions.prototype.createPath=function(){return new paper.Path({strokeWidth:this.stroke.width,strokeColor:this.stroke.colour,fillColor:this.fill.colour})};function BufferView(a,c,b){var d=b.createPath();d.moveTo({x:0,y:0});var f={x:c.wideSegmentWidth-b.stroke.width,y:c.halfHeight};d.lineTo(f);d=a.decorate(d,c,b);f.x=d.bounds.width;d.lineTo({x:0,y:c.height});d.closePath();d.alignmentCentre={x:c.wideSegmentWidth/2,y:c.halfHeight};d.inputs=[{x:0,y:c.halfHeight}];d.outputs=[f];return d};function CircuitView(a,c,b){a=a.map(function(a){return new a(c,b)});for(var d=0;d<a.length;d++){var f=a[d];console.log(f.bounds);if(0==d)f.position={x:0,y:0};else{var e=a[d-1];f.position={x:e.position.x+e.outputs[0].x-e.inputs[0].x,y:e.position.y+e.outputs[0].y-f.inputs[0].y}}}d=new paper.Group(a);f=a[0];a=a[a.length-1];d.inputs=[{x:f.position.x,y:f.position.y+f.inputs[0].y}];d.outputs=[{x:a.position.x+a.outputs[0].x-a.inputs[0].x,y:a.position.y+a.outputs[0].y}];return d};function DimensionsProportionalToWidth(a){this.width=a=a||100;this.wireWidth=a/5;this.gateWidth=a-2*this.wireWidth;this.height=4*this.gateWidth/5;this.halfHeight=this.height/2;this.wideSegmentWidth=3*this.gateWidth/5;this.narrowSegmentWidth=2*this.gateWidth/5;this.inverterRadius=this.gateWidth/12};function dragHandlerChain(a,c){function b(b){for(var a=0;a<c.length&&(c[a].dragFinished(b),!b.stopped);a++);}a.onMouseDown=function(b){for(var a=0;a<c.length&&(c[a].dragStarted(b),!b.stopped);a++);};a.onMouseDrag=function(a){for(var b=0;b<c.length&&(c[b].drag(a),!a.stopped);b++);};a.onMouseUp=b;a.onMouseOut=b};function dragToCopy(a,c,b,d){function f(b){g=null}var e,g,h;a.onMouseDown=function(f){e=a.position;g=f.point;h=c(b,d);h.position={x:e.x,y:e.y};dragHandlerChain(h,[new MetaDragToConnect(h,d),new DragToMove(h,d)])};a.onMouseDrag=function(b){var a=b.point;h.position={x:e.x+a.x-g.x,y:e.y+a.y-g.y};b.stopPropagation()};a.onMouseUp=f;a.onMouseOut=f};function DragToMove(a,c){this.element=a;this.appearance=c}DragToMove.prototype.dragStarted=function(a){this.originalPosition=this.element.position;this.dragPosition=a.point;a.event.metaKey?this.moving=!1:(this.moving=!0,a.stopPropagation())};DragToMove.prototype.drag=function(a){var c=a.point;this.moving&&(this.element.position={x:this.originalPosition.x+c.x-this.dragPosition.x,y:this.originalPosition.y+c.y-this.dragPosition.y},redrawWires(this.appearance),a.stopPropagation())};
DragToMove.prototype.dragFinished=function(a){this.dragPosition=null;redrawWires(this.appearance)};function dragToPan(){function a(b){c=null}var c;paper.view.onMouseDown=function(b){c=b.point};paper.view.onMouseDrag=function(b){b=b.point;paper.view.center=new paper.Point({x:paper.view.center.x-(b.x-c.x),y:paper.view.center.y-(b.y-c.y)})};paper.view.onMouseUp=a;paper.view.onMouseOut=a};function GateView(a,c,b){a=new a(c,b);var d=c.width/2-a.alignmentCentre.x+a.inputs[0].x/2,f=[];f.push(a);c=[{x:c.width-d+a.inputs[0].x,y:a.outputs[0].y}];for(var e=new paper.Path.Line({from:a.outputs[0],to:c[0],strokeWidth:b.wireStrokeWidth,strokeColor:b.stroke.colour}),g=[],h=0;h<a.inputs.length;h++){var k=a.inputs[h];g[h]={x:k.x-d,y:k.y};f.push(new paper.Path.Line({from:g[h],to:{x:k.x,y:k.y},strokeWidth:b.wireStrokeWidth,strokeColor:b.stroke.colour}))}f.push(e);a=new paper.Group(f);a.inputs=g;a.outputs=
c;return a};function clamp(a,c,b){return Math.min(Math.max(a,c),b)};var wires=[];
function redrawWires(a){wires.map(function(c){var b=c.from,d=c.to,f=c.input;null!=c.path&&(null!=c.path.crossings&&c.path.crossings.map(function(b){b.remove()}),c.path.remove(),c.path=null);var e=a.createPath();e.strokeWidth=a.wireStrokeWidth;e.fillColor=null;b={x:b.position.x-b.bounds.width/2+b.outputs[0].x-b.inputs[0].x,y:b.position.y-b.bounds.height/2+b.outputs[0].y};d={x:d.position.x-d.bounds.width/2,y:d.position.y-d.bounds.height/2+d.inputs[f].y};f=d.x-b.x;e.moveTo({x:b.x,y:b.y});e.lineTo({x:b.x+
f/2,y:b.y});e.lineTo({x:b.x+f/2,y:d.y});e.lineTo({x:d.x,y:d.y});e.crossings=[];wires.map(function(c){if(null!=c.path)if(c=c.path.getIntersections(e),0<c.length){console.log(c.length+" intersection(s)");for(var f=0;f<c.length;f++){var k=c[f],m=e.crossings;e.remove();e=a.createPath();e.strokeWidth=a.wireStrokeWidth;e.fillColor=null;var l=d.x-b.x;e.moveTo({x:b.x,y:b.y});k.point.x>=b.x&&k.point.x<=b.x+l/2&&k.point.y==b.y&&(e.lineTo({x:k.point.x-5,y:b.y}),e.arcTo({x:k.point.x,y:b.y-5},{x:k.point.x+5,y:b.y}));
e.lineTo({x:b.x+l/2,y:b.y});k.point.x==b.x+l/2&&k.point.y>=b.y&&k.point.y<=d.y&&(e.lineTo({x:b.x+l/2,y:k.point.y-5}),e.arcTo({x:b.x+l/2+5,y:k.point.y},{x:b.x+l/2,y:k.point.y+5}));e.lineTo({x:b.x+l/2,y:d.y});e.lineTo({x:d.x,y:d.y});e.crossings=m}}else console.log("no intersections")});c.path=e})}function MetaDragToConnect(a,c){this.element=a;this.appearance=c}
MetaDragToConnect.prototype.dragStarted=function(a){this.originalPosition=this.element.position;this.dragPosition=a.point;a.event.metaKey?(this.connecting=!0,a.stopPropagation()):this.connecting=!1};
MetaDragToConnect.prototype.drag=function(a){if(this.connecting){null!=this.path&&this.path.remove();this.path=this.appearance.createPath();this.path.strokeWidth=this.appearance.wireStrokeWidth;this.path.fillColor=null;var c=this.element.position.x-this.element.bounds.width/2+this.element.outputs[0].x-this.element.inputs[0].x,b=this.element.position.y-this.element.bounds.height/2+this.element.outputs[0].y,d=a.point.x,f=a.point.y,e=d-c;this.path.moveTo({x:c,y:b});this.path.lineTo({x:c+e/2,y:b});this.path.lineTo({x:c+
e/2,y:f});this.path.lineTo({x:d,y:f});a.stopPropagation()}};MetaDragToConnect.prototype.dragFinished=function(a){this.dragPosition=null;null!=this.path&&this.path.remove();if(this.connecting){var c=paper.project.hitTest(a.point);if(null!=c){var b=c.item.input;null==b?b=0:b++;if(b>=c.item.inputs.length)return;c.item.input=b;wires.push({from:this.element,to:c.item,input:b})}redrawWires(this.appearance);a.stopPropagation()}};function render(){function a(b){return GateView.bind(null,b)}function c(){}function b(){}paper.project.activeLayer.removeChildren();c.prototype.decorate=function(b,a,c){a=2*a.inverterRadius;b.arcBy({x:a,y:0},!1);b.arcBy({x:-a,y:0},!0);b.arcBy({x:a,y:0},!0);b.arcBy({x:-a,y:0},!1);return b};b.prototype.decorate=function(b,a,c){return b};a(BufferView.bind(null,new b));a(BufferView.bind(null,new c));a(AndView.bind(null,new b));a(AndView.bind(null,new c));new paper.Path.Rectangle({point:[0,0],size:[paper.view.bounds.width,
paper.view.bounds.height],strokeColor:"#ccc"});var d=50;[a(BufferView.bind(null,new b)),a(BufferView.bind(null,new c)),a(AndView.bind(null,new b)),a(AndView.bind(null,new c)),a(OrView.bind(null,new b,new b)),a(OrView.bind(null,new b,new c)),a(OrView.bind(null,new XorDecoration,new b)),a(OrView.bind(null,new XorDecoration,new c))].map(function(b){var a=new DimensionsProportionalToWidth(50),c=new AppearanceProportionalToDimensions(a),h=new AppearanceProportionalToDimensions(a);h.stroke.colour="#ccc";
h=new b(a,h);h.position={x:d,y:50};d+=1.1*h.bounds.width;dragToCopy(h,b,a,c)})}window.addEventListener("load",function(){var a=document.getElementById("paper");paper.setup(a);paper.view.onFrame=function(a){paper.view.draw()};paper.view.onResize=function(a){render()};render();dragToPan();stableScrollToZoom(a)});function OrView(a,c,b,d){var f=b.gateWidth/7,e=d.createPath();e.moveTo({x:d.stroke.width/2,y:0});e.lineTo({x:b.narrowSegmentWidth,y:0});var g={x:b.gateWidth,y:b.halfHeight};e.arcTo({x:b.narrowSegmentWidth+b.wideSegmentWidth/2,y:b.halfHeight/4},g);e=c.decorate(e,b,d);g.x=e.bounds.width;e.arcTo({x:b.narrowSegmentWidth+b.wideSegmentWidth/2,y:b.height-b.halfHeight/4},{x:b.narrowSegmentWidth,y:b.height});e.lineTo({x:d.stroke.width/2,y:b.height});e.arcTo({x:f,y:b.halfHeight},{x:d.stroke.width/2,y:0});e.closePath();
e=a.decorate(e,b,d);e.alignmentCentre={x:b.gateWidth/2-f/2,y:b.halfHeight};a=b.height/4;e.inputs=[{x:f,y:a},{x:f,y:b.height-a}];e.outputs=[g];return e};function stableScrollToZoom(a){var c=0;a.addEventListener("mousewheel",function(b){var a=c+b.wheelDelta,f=clamp(Math.pow(1.001,a),.25,100),e=paper.view.zoom;if(f!=e){var g=e/f,h=paper.view.viewToProject({x:b.offsetX,y:b.offsetY}),e=paper.view.center,k=h.subtract(e),g=h.subtract(k.multiply(g)).subtract(e);paper.view.center=e.add(g);c=a;paper.view.zoom=f}b.preventDefault();return!1})};function XorDecoration(){}XorDecoration.prototype.decorate=function(a,c,b){var d=c.gateWidth/7,f=b.createPath(),e=2*b.stroke.width,g=1.2*(b.stroke.width/2-e),d=d-e;b=b.stroke.width/10;f.moveTo({x:g+b,y:0});f.lineTo({x:g,y:0});f.arcTo({x:d,y:c.halfHeight},{x:g,y:c.height});f.lineTo({x:g+b,y:c.height});f.arcTo({x:d,y:c.halfHeight},{x:g,y:0});f.lineTo({x:g+b,y:0});f.arcTo({x:d,y:c.halfHeight},{x:g,y:c.height});return new paper.Group([a,f])};
